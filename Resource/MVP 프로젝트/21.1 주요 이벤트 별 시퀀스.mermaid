sequenceDiagram
    participant U as ì‚¬ìš©ì
    participant RPi as ë¼ì¦ˆë² ë¦¬íŒŒì´
    participant MQTT as MQTT Broker
    participant BE as Backend Server
    participant Redis as Redis Cache
    participant DB as MongoDB
    participant API as External APIs
    
    %% ì‹œë‚˜ë¦¬ì˜¤ 1: ìŒì„± ëª…ë ¹ ì²˜ë¦¬
    Note over U,API: ì‹œë‚˜ë¦¬ì˜¤ 1: "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?" ìŒì„± ëª…ë ¹
    
    U->>RPi: "í—¤ì´ ìŠ¤í”¼ì»¤"
    activate RPi
    RPi->>RPi: Wake Word ê°ì§€ (Porcupine)
    RPi->>U: ğŸ”” ëµë™ (ë“£ê¸° ì‹œì‘)
    U->>RPi: "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?"
    RPi->>RPi: ìŒì„± ë…¹ìŒ (5ì´ˆ)
    RPi->>RPi: ì˜¤ë””ì˜¤ ì „ì²˜ë¦¬<br/>- ë…¸ì´ì¦ˆ ì œê±°<br/>- ì •ê·œí™”
    
    RPi->>MQTT: Publish: device/{id}/audio<br/>{"audio": "base64...", "metadata": {...}}
    deactivate RPi
    
    MQTT->>BE: Message: audio data
    activate BE
    
    BE->>BE: DeviceMessageHandler.handleMessage()
    BE->>API: Google STT API<br/>transcribe(audioData)
    API-->>BE: "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?"
    
    BE->>BE: DialogManager.processUserInput()
    BE->>Redis: GET context:user123:session456
    Redis-->>BE: null (ìºì‹œ ë¯¸ìŠ¤)
    
    BE->>DB: findContext(userId, sessionId)
    DB-->>BE: null (ì²« ëŒ€í™”)
    BE->>BE: createNewContext()
    BE->>Redis: SET context:user123:session456
    
    BE->>API: Dialogflow analyzeIntent()
    API-->>BE: Intent: weather.query<br/>Entity: {date: "today"}
    
    BE->>BE: PluginManager.selectPlugin()
    BE->>BE: WeatherPlugin.execute()
    
    BE->>Redis: GET weather:seoul
    Redis-->>BE: null (ìºì‹œ ë¯¸ìŠ¤)
    
    BE->>API: OpenWeatherMap API
    API-->>BE: {"temp": 23, "condition": "clear"}
    
    BE->>Redis: SET weather:seoul (TTL: 30ë¶„)
    BE->>BE: buildResponse("ë§‘ìŒ, 23ë„")
    
    BE->>API: Google TTS API
    API-->>BE: MP3 audio data
    
    BE->>MQTT: Publish: device/{id}/response<br/>{"audio": "...", "text": "..."}
    deactivate BE
    
    MQTT->>RPi: Response message
    activate RPi
    RPi->>RPi: Speaker.play_audio()
    RPi->>U: "ì˜¤ëŠ˜ ì„œìš¸ì€ ë§‘ê³  23ë„ì…ë‹ˆë‹¤"
    deactivate RPi
    
    Note over BE,DB: ë¹„ë™ê¸° ì‘ì—…
    BE-->>DB: saveDialogHistory()
    BE-->>MQTT: Publish: analytics/dialog-completed
    
    %% ì‹œë‚˜ë¦¬ì˜¤ 2: í”„ë¡œì•¡í‹°ë¸Œ ëŒ€í™”
    Note over U,API: ì‹œë‚˜ë¦¬ì˜¤ 2: ì•„ì¹¨ ì¸ì‚¬ (í”„ë¡œì•¡í‹°ë¸Œ)
    
    RPi->>RPi: MotionSensor.detect()
    activate RPi
    RPi->>MQTT: Publish: device/{id}/event<br/>{"type": "motion", "time": "07:00"}
    deactivate RPi
    
    MQTT->>BE: Motion event
    activate BE
    BE->>BE: ProactiveEngine.evaluate()
    BE->>Redis: GET context:user123:*
    Redis-->>BE: Context (lastGreeting: yesterday)
    
    BE->>BE: Rule: morning_greeting matches!
    BE->>API: Weather API (for greeting)
    API-->>BE: Weather data
    
    BE->>BE: Generate: "ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”!<br/>ì˜¤ëŠ˜ì€ ë¹„ê°€ ì˜¬ ì˜ˆì •ì´ë‹ˆ<br/>ìš°ì‚°ì„ ì±™ê¸°ì„¸ìš”"
    
    BE->>API: Google TTS
    API-->>BE: Audio data
    
    BE->>MQTT: Publish: device/{id}/proactive<br/>{"audio": "...", "rule": "morning_greeting"}
    deactivate BE
    
    MQTT->>RPi: Proactive message
    activate RPi
    RPi->>U: "ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”!..."
    deactivate RPi
    
    %% ì‹œë‚˜ë¦¬ì˜¤ 3: ì—°ì† ëŒ€í™”
    Note over U,API: ì‹œë‚˜ë¦¬ì˜¤ 3: ì»¨í…ìŠ¤íŠ¸ í™œìš© ì—°ì† ëŒ€í™”
    
    U->>RPi: "ë‚´ì¼ì€?"
    activate RPi
    RPi->>MQTT: Audio data
    deactivate RPi
    
    MQTT->>BE: Audio message
    activate BE
    BE->>API: STT
    API-->>BE: "ë‚´ì¼ì€?"
    
    BE->>Redis: GET context:user123:session456
    Redis-->>BE: Context {lastIntent: "weather.query"}
    
    BE->>BE: ì»¨í…ìŠ¤íŠ¸ ì¶”ë¡ <br/>ì´ì „: ë‚ ì”¨ ì§ˆë¬¸<br/>â†’ "ë‚´ì¼ ë‚ ì”¨"
    
    BE->>API: Dialogflow with context
    API-->>BE: Intent: weather.query<br/>Entity: {date: "tomorrow"}
    
    BE->>BE: WeatherPlugin.execute()
    BE->>API: Weather forecast API
    API-->>BE: Tomorrow weather
    
    BE->>MQTT: Response
    deactivate BE
    
    MQTT->>RPi: Audio response
    RPi->>U: "ë‚´ì¼ì€ íë¦¬ê³  18ë„..."
    
    %% ìŠ¤íƒ€ì¼
    rect rgb(230, 245, 255)
        Note right of U: ìŒì„± ì…ë ¥ êµ¬ê°„
    end
    
    rect rgb(255, 245, 230)
        Note right of BE: ì²˜ë¦¬ êµ¬ê°„
    end
    
    rect rgb(245, 255, 230)
        Note right of API: ì™¸ë¶€ ì„œë¹„ìŠ¤ êµ¬ê°„
    end