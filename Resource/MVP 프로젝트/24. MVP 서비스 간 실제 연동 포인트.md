# MVP ì„œë¹„ìŠ¤ ê°„ ì‹¤ì œ ì—°ë™ í¬ì¸íŠ¸

## ğŸ”— ì£¼ìš” ì—°ë™ ì§€ì 

### 1. Raspberry Pi â†” Backend Server

#### 1.1 ì˜¤ë””ì˜¤ ë°ì´í„° ì „ì†¡
```python
# Raspberry Pi â†’ Backend
async def send_audio_to_backend(self, audio_data):
    """ìŒì„± ë°ì´í„°ë¥¼ ë°±ì—”ë“œë¡œ ì „ì†¡"""
    
    # ë°©ë²• 1: MQTT (ì¶”ì²œ - ì‹ ë¢°ì„±, ì €ëŒ€ì—­í­)
    message = {
        "deviceId": self.device_id,
        "timestamp": time.time(),
        "audio": {
            "data": base64.b64encode(audio_data).decode('utf-8'),
            "format": "PCM",
            "sampleRate": 16000,
            "duration": len(audio_data) / 16000
        },
        "metadata": {
            "noiseLevel": self.get_noise_level(),
            "wifiStrength": self.get_wifi_strength()
        }
    }
    
    await self.mqtt_client.publish(
        f"device/{self.device_id}/audio",
        json.dumps(message),
        qos=1  # At least once delivery
    )
    
    # ë°©ë²• 2: HTTP REST API (ëŒ€ì•ˆ)
    response = await self.http_client.post(
        f"{self.backend_url}/api/dialog/audio",
        files={'audio': audio_data},
        data={'deviceId': self.device_id}
    )
    
    # ë°©ë²• 3: WebSocket (ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°)
    async for chunk in self.audio_stream:
        await self.websocket.send(chunk)
```

#### 1.2 ì´ë²¤íŠ¸ ì•Œë¦¼
```python
# Motion/Environment ì„¼ì„œ â†’ Backend
class EventNotifier:
    def __init__(self, mqtt_client):
        self.mqtt_client = mqtt_client
        self.event_queue = asyncio.Queue()
        
    async def notify_motion_detected(self):
        event = {
            "eventType": "motion_detected",
            "timestamp": time.time(),
            "data": {
                "location": "living_room",
                "intensity": self.motion_sensor.get_intensity()
            }
        }
        
        # ì¦‰ì‹œ ì „ì†¡ + íì‰ (ë„¤íŠ¸ì›Œí¬ ë¶ˆì•ˆì • ëŒ€ë¹„)
        try:
            await self.mqtt_client.publish(
                f"device/{self.device_id}/event",
                json.dumps(event)
            )
        except NetworkError:
            await self.event_queue.put(event)
```

### 2. Backend Services ê°„ ì—°ë™

#### 2.1 DialogManager â†’ ContextEngine
```java
@Service
public class DialogManagerImpl implements DialogManager {
    
    // ë°©ë²• 1: ì§ì ‘ ì˜ì¡´ì„± ì£¼ì… (Monolithic)
    @Autowired
    private ContextEngine contextEngine;
    
    // ë°©ë²• 2: HTTP Client (Microservices)
    @Autowired
    private ContextServiceClient contextClient;
    
    public DialogResponse processDialog(DialogRequest request) {
        // Monolithic ë°©ì‹
        Context context = contextEngine.getOrCreateContext(
            request.getUserId(), 
            request.getSessionId()
        );
        
        // Microservice ë°©ì‹
        Context context = contextClient.getContext(
            request.getUserId(),
            request.getSessionId()
        ).block(Duration.ofSeconds(2));
        
        // í•˜ì´ë¸Œë¦¬ë“œ: ìºì‹œ + ì›ê²© í˜¸ì¶œ
        Context context = contextCache.get(request.getSessionId())
            .orElseGet(() -> contextClient.getContext(
                request.getUserId(), 
                request.getSessionId()
            ).block());
    }
}
```

#### 2.2 DialogManager â†’ NLU Service (Dialogflow)
```java
@Component
public class DialogflowIntegration {
    
    private final SessionsClient sessionsClient;
    private final CircuitBreaker circuitBreaker;
    
    public Intent analyzeIntent(String text, Context context) {
        // Circuit Breakerë¡œ ë³´í˜¸
        return circuitBreaker.executeSupplier(() -> {
            // Dialogflow ì„¸ì…˜ ìƒì„±
            SessionName session = SessionName.of(
                projectId, 
                context.getSessionId()
            );
            
            // ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì „ë‹¬
            QueryInput queryInput = QueryInput.newBuilder()
                .setText(TextInput.newBuilder()
                    .setText(text)
                    .setLanguageCode("ko"))
                .build();
            
            // ì´ì „ ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
            List<com.google.cloud.dialogflow.v2.Context> dialogflowContexts = 
                buildDialogflowContexts(context);
                
            DetectIntentRequest request = DetectIntentRequest.newBuilder()
                .setSession(session.toString())
                .setQueryInput(queryInput)
                .addAllQueryParams(buildQueryParams(context))
                .build();
                
            DetectIntentResponse response = sessionsClient.detectIntent(request);
            
            return mapToIntent(response.getQueryResult());
        });
    }
    
    // Fallback: ë¡œì»¬ NLU
    public Intent analyzeIntentLocal(String text) {
        // ê°„ë‹¨í•œ í‚¤ì›Œë“œ ë§¤ì¹­
        if (text.contains("ë‚ ì”¨")) return new Intent("weather.query");
        if (text.contains("ì‹œê°„")) return new Intent("time.query");
        return new Intent("unknown");
    }
}
```

#### 2.3 Plugin â†’ External APIs
```java
@Component
public class WeatherPlugin extends BasePlugin {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Autowired
    private WebClient webClient;  // ë¹„ë™ê¸°
    
    @Value("${weather.api.key}")
    private String apiKey;
    
    @Override
    protected PluginResponse doExecute(Intent intent, Context context) {
        String location = extractLocation(intent, context);
        
        // ë™ê¸° í˜¸ì¶œ (RestTemplate)
        WeatherData weather = fetchWeatherSync(location);
        
        // ë¹„ë™ê¸° í˜¸ì¶œ (WebClient)
        Mono<WeatherData> weatherMono = fetchWeatherAsync(location);
        
        // ì—¬ëŸ¬ API ì¡°í•©
        Mono<CompleteWeatherInfo> completeInfo = Mono.zip(
            fetchCurrentWeather(location),
            fetchWeatherForecast(location),
            fetchAirQuality(location)
        ).map(tuple -> CompleteWeatherInfo.of(
            tuple.getT1(), tuple.getT2(), tuple.getT3()
        ));
        
        return buildResponse(completeInfo.block());
    }
    
    private WeatherData fetchWeatherSync(String location) {
        String url = UriComponentsBuilder
            .fromHttpUrl("https://api.openweathermap.org/data/2.5/weather")
            .queryParam("q", location)
            .queryParam("appid", apiKey)
            .queryParam("units", "metric")
            .queryParam("lang", "kr")
            .toUriString();
            
        try {
            ResponseEntity<WeatherApiResponse> response = 
                restTemplate.getForEntity(url, WeatherApiResponse.class);
                
            if (response.getStatusCode().is2xxSuccessful()) {
                return mapToWeatherData(response.getBody());
            }
            
        } catch (RestClientException e) {
            log.error("Weather API call failed", e);
            // Fallback ë°ì´í„° ì‚¬ìš©
            return getLastKnownWeather(location);
        }
    }
}
```

### 3. ë°ì´í„° ì €ì¥ì†Œ ì—°ë™

#### 3.1 Redis ìºì‹± í†µí•©
```java
@Configuration
@EnableCaching
public class CacheIntegration {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory cf) {
        RedisCacheConfiguration config = RedisCacheConfiguration
            .defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10))
            .serializeKeysWith(keySerializationPair())
            .serializeValuesWith(valueSerializationPair());
            
        return RedisCacheManager.builder(cf)
            .cacheDefaults(config)
            .withCacheConfiguration("contexts", 
                config.entryTtl(Duration.ofHours(1)))
            .withCacheConfiguration("weather",
                config.entryTtl(Duration.ofMinutes(30)))
            .build();
    }
}

@Service
public class CachedWeatherService {
    
    @Autowired
    private RedisTemplate<String, WeatherData> redisTemplate;
    
    public WeatherData getWeather(String location) {
        String key = "weather:" + location;
        
        // 1. ìºì‹œ í™•ì¸
        WeatherData cached = redisTemplate.opsForValue().get(key);
        if (cached != null && !cached.isExpired()) {
            return cached;
        }
        
        // 2. ìºì‹œ ë¯¸ìŠ¤ - API í˜¸ì¶œ
        WeatherData fresh = weatherApiClient.fetchWeather(location);
        
        // 3. ìºì‹œ ì €ì¥ with TTL
        redisTemplate.opsForValue().set(
            key, 
            fresh, 
            Duration.ofMinutes(30)
        );
        
        return fresh;
    }
}
```

#### 3.2 MongoDB ì—°ë™
```java
@Service
public class ContextPersistenceService {
    
    @Autowired
    private MongoTemplate mongoTemplate;
    
    @Autowired
    private ReactiveMongoTemplate reactiveMongoTemplate;
    
    // ë™ê¸° ì €ì¥
    public void saveContext(Context context) {
        Query query = Query.query(
            Criteria.where("userId").is(context.getUserId())
                .and("sessionId").is(context.getSessionId())
        );
        
        Update update = Update.update("lastUpdated", LocalDateTime.now())
            .set("conversationHistory", context.getConversationHistory())
            .inc("turnCount", 1);
            
        mongoTemplate.upsert(query, update, Context.class);
    }
    
    // ë¹„ë™ê¸° ì €ì¥ (ì„±ëŠ¥ ê°œì„ )
    public Mono<Context> saveContextAsync(Context context) {
        return reactiveMongoTemplate.save(context)
            .doOnSuccess(saved -> log.debug("Context saved: {}", saved.getId()))
            .doOnError(error -> log.error("Failed to save context", error));
    }
}
```

### 4. ì´ë²¤íŠ¸ ê¸°ë°˜ í†µí•©

#### 4.1 Event Bus êµ¬í˜„
```java
@Component
public class InternalEventBus {
    
    private final ApplicationEventPublisher eventPublisher;
    private final KafkaTemplate<String, Object> kafkaTemplate;
    
    // ë¡œì»¬ ì´ë²¤íŠ¸ (ê°™ì€ JVM)
    public void publishLocal(ApplicationEvent event) {
        eventPublisher.publishEvent(event);
    }
    
    // ë¶„ì‚° ì´ë²¤íŠ¸ (ë‹¤ë¥¸ ì„œë¹„ìŠ¤)
    public void publishDistributed(String topic, DomainEvent event) {
        kafkaTemplate.send(topic, event.getAggregateId(), event);
    }
    
    // í•˜ì´ë¸Œë¦¬ë“œ ë°œí–‰
    public void publish(DomainEvent event) {
        // ë¡œì»¬ ë¦¬ìŠ¤ë„ˆì—ê²Œ ì¦‰ì‹œ ì „ë‹¬
        publishLocal(new LocalEventWrapper(event));
        
        // ì™¸ë¶€ ì„œë¹„ìŠ¤ë¥¼ ìœ„í•´ Kafkaë¡œë„ ë°œí–‰
        if (event.isExternallyVisible()) {
            publishDistributed(event.getTopic(), event);
        }
    }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
@Component
public class DialogEventListener {
    
    @EventListener
    @Async
    public void handleDialogCompleted(DialogCompletedEvent event) {
        // í†µê³„ ì—…ë°ì´íŠ¸
        statisticsService.updateDialogMetrics(event);
        
        // ì‚¬ìš©ì í™œë™ ê¸°ë¡
        activityService.recordActivity(event.getUserId(), event);
        
        // í”„ë¡œì•¡í‹°ë¸Œ ê·œì¹™ í‰ê°€
        proactiveEngine.evaluateRules(event);
    }
    
    @KafkaListener(topics = "dialog-events")
    public void handleExternalDialogEvent(String message) {
        DialogEvent event = deserialize(message);
        // ì™¸ë¶€ ì„œë¹„ìŠ¤ì—ì„œ ì˜¨ ì´ë²¤íŠ¸ ì²˜ë¦¬
    }
}
```

## ğŸ”§ í†µí•© íŒ¨í„´ ë° ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. Retry ë° Timeout ì„¤ì •
```java
@Configuration
public class IntegrationConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(3000);
        factory.setReadTimeout(5000);
        
        RestTemplate template = new RestTemplate(factory);
        
        // Retry ì¸í„°ì…‰í„° ì¶”ê°€
        template.getInterceptors().add(new RetryInterceptor());
        
        return template;
    }
    
    @Bean
    public RetryTemplate retryTemplate() {
        return RetryTemplate.builder()
            .maxAttempts(3)
            .exponentialBackoff(100, 2, 1000)
            .retryOn(RestClientException.class)
            .build();
    }
}
```

### 2. Health Check ë° ëª¨ë‹ˆí„°ë§
```java
@Component
public class IntegrationHealthIndicator implements HealthIndicator {
    
    @Autowired
    private List<ExternalServiceClient> externalClients;
    
    @Override
    public Health health() {
        Map<String, Status> serviceStatuses = new HashMap<>();
        
        for (ExternalServiceClient client : externalClients) {
            try {
                boolean isHealthy = client.checkHealth();
                serviceStatuses.put(
                    client.getServiceName(), 
                    isHealthy ? Status.UP : Status.DOWN
                );
            } catch (Exception e) {
                serviceStatuses.put(client.getServiceName(), Status.DOWN);
            }
        }
        
        boolean allHealthy = serviceStatuses.values().stream()
            .allMatch(status -> status == Status.UP);
            
        return Health.status(allHealthy ? Status.UP : Status.DOWN)
            .withDetails(serviceStatuses)
            .build();
    }
}
```

### 3. ë²„ì „ í˜¸í™˜ì„± ê´€ë¦¬
```java
@Component
public class VersionAwareClient {
    
    public DialogResponse callDialogService(DialogRequest request) {
        String version = request.getApiVersion();
        
        switch (version) {
            case "v1":
                return callV1Api(request);
            case "v2":
                return callV2Api(request);
            default:
                throw new UnsupportedVersionException(version);
        }
    }
    
    private DialogResponse callV2Api(DialogRequest request) {
        // V2 APIëŠ” ì¶”ê°€ í•„ë“œ ì§€ì›
        V2Request v2Request = V2Request.from(request)
            .withContext(request.getContext())
            .withMetadata(request.getMetadata());
            
        V2Response v2Response = v2Client.process(v2Request);
        
        return mapToDialogResponse(v2Response);
    }
}
```