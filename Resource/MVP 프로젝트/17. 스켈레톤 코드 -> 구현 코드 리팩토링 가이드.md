# ìŠ¤ì¼ˆë ˆí†¤ ì½”ë“œ â†’ êµ¬í˜„ ì½”ë“œ ë¦¬íŒ©í† ë§ ê°€ì´ë“œ

## ğŸ¯ ë‹¨ê³„ë³„ êµ¬í˜„ ì „ëµ

### Phase 1: ê¸°ì´ˆ ë³´ê°• (1-2ì£¼ì°¨)

#### 1. ì—ëŸ¬ ì²˜ë¦¬ ì²´ê³„ êµ¬ì¶•
```java
// Step 1: ì»¤ìŠ¤í…€ ì˜ˆì™¸ ì •ì˜
public class DialogException extends Exception {
    private final ErrorCode errorCode;
    private final Map<String, Object> context;
}

// Step 2: ê¸€ë¡œë²Œ ì˜ˆì™¸ í•¸ë“¤ëŸ¬
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(DialogException.class)
    public ResponseEntity<ErrorResponse> handleDialogException(DialogException e) {
        // ë¡œê¹…, ë©”íŠ¸ë¦­, ì‘ë‹µ ìƒì„±
    }
}

// Step 3: ê° ì„œë¹„ìŠ¤ì— ì ìš©
public DialogResponse processUserInput(String userId, String text) {
    if (StringUtils.isBlank(text)) {
        throw new DialogException(ErrorCode.INVALID_INPUT, "text", text);
    }
    // ...
}
```

#### 2. ì„¤ì • ê´€ë¦¬ ê°•í™”
```yaml
# application.yml â†’ application-{profile}.yml ë¶„ë¦¬
# application-local.yml
ai-speaker:
  dialog:
    timeout: 5000
    max-retries: 3
    cache:
      enabled: false
  
# application-prod.yml  
ai-speaker:
  dialog:
    timeout: 2000
    max-retries: 5
    cache:
      enabled: true
      ttl: 600
```

#### 3. ë¡œê¹… í”„ë ˆì„ì›Œí¬ ì„¤ì •
```java
// MDC (Mapped Diagnostic Context) í™œìš©
public class LoggingInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        MDC.put("requestId", UUID.randomUUID().toString());
        MDC.put("userId", extractUserId(request));
        return true;
    }
}
```

### Phase 2: í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„ (3-4ì£¼ì°¨)

#### 1. Dialog Manager ì™„ì„±
```java
@Service
@Slf4j
public class DialogManagerImpl implements DialogManager {
    
    // ì˜ì¡´ì„± ì£¼ì…
    private final ContextEngine contextEngine;
    private final NLUService nluService;
    private final PluginManager pluginManager;
    private final MetricService metricService;
    private final CircuitBreaker circuitBreaker;
    
    @Override
    public DialogResponse processUserInput(DialogRequest request) {
        // 1. ìš”ì²­ ID ìƒì„± (ì¶”ì ìš©)
        String requestId = generateRequestId();
        MDC.put("dialogRequestId", requestId);
        
        StopWatch stopWatch = StopWatch.createStarted();
        
        try {
            // 2. ì…ë ¥ ê²€ì¦
            validateRequest(request);
            
            // 3. ì‚¬ìš©ì ìƒíƒœ í™•ì¸
            UserState userState = getUserState(request.getUserId());
            checkUserEligibility(userState);
            
            // 4. ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ (ìºì‹œ â†’ DB)
            ConversationContext context = loadContextWithCache(
                request.getUserId(), 
                request.getSessionId()
            );
            
            // 5. ë³‘ë ¬ ì²˜ë¦¬ë¡œ ì„±ëŠ¥ ê°œì„ 
            CompletableFuture<Intent> intentFuture = 
                CompletableFuture.supplyAsync(() -> 
                    analyzeIntent(request.getText(), context));
            
            CompletableFuture<SentimentAnalysis> sentimentFuture = 
                CompletableFuture.supplyAsync(() -> 
                    analyzeSentiment(request.getText()));
            
            // 6. ê²°ê³¼ ì¡°í•©
            Intent intent = intentFuture.get(2, TimeUnit.SECONDS);
            SentimentAnalysis sentiment = sentimentFuture.get(1, TimeUnit.SECONDS);
            
            // 7. í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰
            PluginResponse response = executePluginsWithFallback(
                intent, context, sentiment
            );
            
            // 8. ì‘ë‹µ í›„ì²˜ë¦¬
            DialogResponse finalResponse = postProcessResponse(
                response, context, sentiment
            );
            
            // 9. ë¹„ë™ê¸° ì‘ì—…
            asyncTasks(request, finalResponse, context, stopWatch.getTime());
            
            return finalResponse;
            
        } catch (TimeoutException e) {
            metricService.incrementTimeout("dialog.processing");
            return createTimeoutResponse();
        } catch (Exception e) {
            return handleError(e, request, stopWatch.getTime());
        } finally {
            MDC.clear();
        }
    }
    
    private PluginResponse executePluginsWithFallback(
            Intent intent, 
            ConversationContext context,
            SentimentAnalysis sentiment) {
        
        // Circuit Breaker íŒ¨í„´ ì ìš©
        return circuitBreaker.executeSupplier(() -> {
            List<ConversationPlugin> plugins = pluginManager.selectPlugins(intent);
            
            if (plugins.isEmpty()) {
                return createFallbackResponse(intent);
            }
            
            // í”ŒëŸ¬ê·¸ì¸ ìš°ì„ ìˆœìœ„ ì •ë ¬
            plugins.sort(Comparator.comparing(ConversationPlugin::getPriority).reversed());
            
            // ì²« ë²ˆì§¸ ì„±ê³µí•œ í”ŒëŸ¬ê·¸ì¸ ì‘ë‹µ ë°˜í™˜
            for (ConversationPlugin plugin : plugins) {
                try {
                    PluginResponse response = plugin.execute(intent, context);
                    if (response.isSuccess()) {
                        return response;
                    }
                } catch (Exception e) {
                    log.warn("Plugin {} failed: {}", plugin.getInfo().getName(), e.getMessage());
                }
            }
            
            return createFallbackResponse(intent);
        });
    }
}
```

#### 2. Plugin êµ¬í˜„ íŒ¨í„´
```java
@Component
@Slf4j
public abstract class BasePluginImpl implements ConversationPlugin {
    
    @Autowired
    private PluginMetricService metricService;
    
    @Autowired
    private CacheManager cacheManager;
    
    @Override
    public final PluginResponse execute(Intent intent, ConversationContext context) {
        String pluginName = getInfo().getName();
        Timer.Sample sample = Timer.start();
        
        try {
            // ê¶Œí•œ ì²´í¬
            checkPermissions(context.getUserId());
            
            // ìºì‹œ í™•ì¸
            String cacheKey = generateCacheKey(intent, context);
            PluginResponse cached = getFromCache(cacheKey);
            if (cached != null) {
                metricService.incrementCacheHit(pluginName);
                return cached;
            }
            
            // ì‹¤ì œ ì‹¤í–‰
            PluginResponse response = doExecute(intent, context);
            
            // ìºì‹œ ì €ì¥
            if (response.isCacheable()) {
                saveToCache(cacheKey, response);
            }
            
            return response;
            
        } catch (Exception e) {
            log.error("Plugin execution failed: {}", pluginName, e);
            metricService.incrementError(pluginName);
            return handlePluginError(e, intent, context);
            
        } finally {
            sample.stop(metricService.getTimer(pluginName));
        }
    }
    
    // í•˜ìœ„ í´ë˜ìŠ¤ì—ì„œ êµ¬í˜„
    protected abstract PluginResponse doExecute(Intent intent, ConversationContext context);
    protected abstract void checkPermissions(String userId);
}
```

### Phase 3: í†µí•© ë° ìµœì í™” (5-6ì£¼ì°¨)

#### 1. ìºì‹± ì „ëµ
```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer()));
        
        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(config)
            .withCacheConfiguration("context", config.entryTtl(Duration.ofHours(1)))
            .withCacheConfiguration("weather", config.entryTtl(Duration.ofMinutes(30)))
            .build();
    }
}

// ì‚¬ìš© ì˜ˆ
@Cacheable(value = "context", key = "#userId + ':' + #sessionId")
public ConversationContext getContext(String userId, String sessionId) {
    return contextRepository.findByUserIdAndSessionId(userId, sessionId);
}
```

#### 2. ë¹„ë™ê¸° ì²˜ë¦¬
```java
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(500);
        executor.setThreadNamePrefix("Async-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}

@Service
public class AsyncService {
    
    @Async
    public CompletableFuture<Void> saveDialogHistory(DialogHistory history) {
        try {
            dialogRepository.save(history);
            eventPublisher.publish(new DialogSavedEvent(history));
        } catch (Exception e) {
            log.error("Failed to save dialog history", e);
        }
        return CompletableFuture.completedFuture(null);
    }
}
```

## ğŸš¨ ì£¼ì˜ì‚¬í•­ ë° ì¤‘ìš” í¬ì¸íŠ¸

### 1. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
```java
// ì…ë ¥ ê²€ì¦
public class InputValidator {
    private static final int MAX_TEXT_LENGTH = 1000;
    private static final Pattern SAFE_TEXT_PATTERN = Pattern.compile("^[\\p{L}\\p{N}\\s.,!?'-]+$");
    
    public void validateUserInput(String text) {
        if (text.length() > MAX_TEXT_LENGTH) {
            throw new ValidationException("Input too long");
        }
        
        // SQL Injection ë°©ì§€
        if (text.contains("';") || text.contains("--")) {
            throw new SecurityException("Potential SQL injection detected");
        }
        
        // XSS ë°©ì§€
        String sanitized = Jsoup.clean(text, Whitelist.none());
        if (!sanitized.equals(text)) {
            throw new SecurityException("HTML/Script tags not allowed");
        }
    }
}
```

### 2. ì„±ëŠ¥ ìµœì í™”
```java
// ì—°ê²° í’€ ì„¤ì •
@Configuration
public class DatabaseConfig {
    
    @Bean
    @ConfigurationProperties("spring.datasource.hikari")
    public HikariConfig hikariConfig() {
        HikariConfig config = new HikariConfig();
        config.setMaximumPoolSize(20);
        config.setMinimumIdle(5);
        config.setIdleTimeout(300000);
        config.setConnectionTimeout(30000);
        config.setLeakDetectionThreshold(60000);
        return config;
    }
}
```

### 3. í…ŒìŠ¤íŠ¸ ì „ëµ
```java
// í†µí•© í…ŒìŠ¤íŠ¸
@SpringBootTest
@AutoConfigureMockMvc
@TestPropertySource(locations = "classpath:application-test.properties")
class DialogIntegrationTest {
    
    @Test
    @Sql("/test-data.sql")
    void testCompleteDialogFlow() {
        // Given
        DialogRequest request = createTestRequest();
        
        // When
        mockMvc.perform(post("/api/dialog")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.speech").isNotEmpty())
                .andExpect(jsonPath("$.intent").value("weather.query"));
        
        // Then
        verify(weatherApiClient, times(1)).getWeather(anyString());
    }
}
```

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­
- [ ] ëª¨ë“  public ë©”ì„œë“œì— ì…ë ¥ ê²€ì¦
- [ ] ì˜ˆì™¸ ì²˜ë¦¬ ë° ë³µêµ¬ ì „ëµ
- [ ] íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •
- [ ] íƒ€ì„ì•„ì›ƒ ì„¤ì •
- [ ] ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§
- [ ] ìºì‹± ì „ëµ
- [ ] ë™ì‹œì„± ì²˜ë¦¬
- [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ 70% ì´ìƒ

### ì„±ëŠ¥ ëª©í‘œ
- [ ] API ì‘ë‹µì‹œê°„ < 200ms (P95)
- [ ] ë™ì‹œ ì‚¬ìš©ì 100ëª… ì²˜ë¦¬
- [ ] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ < 512MB
- [ ] CPU ì‚¬ìš©ë¥  < 70%

### ë³´ì•ˆ ì²´í¬
- [ ] OWASP Top 10 ëŒ€ì‘
- [ ] ì…ë ¥ ê²€ì¦ ë° ì‚´ê· 
- [ ] ì¸ì¦/ì¸ê°€ êµ¬í˜„
- [ ] ë¯¼ê° ë°ì´í„° ì•”í˜¸í™”
- [ ] ë³´ì•ˆ í—¤ë” ì„¤ì •