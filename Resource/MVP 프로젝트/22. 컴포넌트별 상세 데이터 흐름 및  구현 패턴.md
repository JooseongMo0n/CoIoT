# MVP ì»´í¬ë„ŒíŠ¸ë³„ ìƒì„¸ ë°ì´í„° íë¦„

## ğŸ”„ ì£¼ìš” ë°ì´í„° íë¦„ íŒ¨í„´

### 1. Request-Response íŒ¨í„´
```
ì…ë ¥ ë°ì´í„° â†’ ê²€ì¦ â†’ ì²˜ë¦¬ â†’ ë³€í™˜ â†’ ì‘ë‹µ
```

### 2. Event-Driven íŒ¨í„´
```
ì´ë²¤íŠ¸ ë°œìƒ â†’ êµ¬ë…ì ì•Œë¦¼ â†’ ë¹„ë™ê¸° ì²˜ë¦¬ â†’ ìƒíƒœ ì—…ë°ì´íŠ¸
```

### 3. Pipeline íŒ¨í„´
```
ë°ì´í„° â†’ ì „ì²˜ë¦¬ â†’ ë¶„ì„ â†’ ì‹¤í–‰ â†’ í›„ì²˜ë¦¬ â†’ ê²°ê³¼
```

## ğŸ“¦ ì»´í¬ë„ŒíŠ¸ë³„ ìƒì„¸ êµ¬í˜„

### A. DialogManager ë°ì´í„° íë¦„

```java
// ì…ë ¥ ë°ì´í„° êµ¬ì¡°
DialogRequest {
    userId: "user123",
    deviceId: "device456", 
    sessionId: "session789",
    text: "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?",
    metadata: {
        timestamp: 1234567890,
        location: {lat: 37.5665, lng: 126.9780}
    }
}

// ì²˜ë¦¬ ê³¼ì •
1. ì…ë ¥ ê²€ì¦
   - userId ì¡´ì¬ ì—¬ë¶€
   - text ê¸¸ì´ ì œí•œ (max 1000ì)
   - í•„ìˆ˜ í•„ë“œ í™•ì¸

2. Context ë¡œë“œ
   Redis Key: "context:user123:session789"
   Data: {
       conversationHistory: [...],
       userPreferences: {...},
       lastInteraction: "2024-01-20T10:30:00"
   }

3. Intent ë¶„ì„
   Dialogflow Request: {
       query: "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?",
       languageCode: "ko",
       contexts: [previousContext]
   }
   
   Response: {
       intent: "weather.query",
       parameters: {date: "today"},
       confidence: 0.95
   }

4. Plugin ì‹¤í–‰
   WeatherPlugin.execute(intent, context)
   â†’ Cache Check: "weather:seoul:2024-01-20"
   â†’ API Call (if cache miss)
   â†’ Response Generation

5. ìµœì¢… ì‘ë‹µ
   DialogResponse {
       speech: "ì˜¤ëŠ˜ ì„œìš¸ì€ ë§‘ê³  23ë„ì…ë‹ˆë‹¤",
       intent: "weather.query",
       confidence: 0.95,
       processingTime: 145,
       contextUpdate: {
           lastWeatherQuery: 1234567890
       }
   }
```

### B. Plugin ì‹œìŠ¤í…œ ë°ì´í„° íë¦„

```java
// Plugin Registry êµ¬ì¡°
Map<String, ConversationPlugin> {
    "weather" â†’ WeatherPlugin instance,
    "time" â†’ TimePlugin instance,
    "greeting" â†’ GreetingPlugin instance
}

// Plugin ì„ íƒ ì•Œê³ ë¦¬ì¦˜
1. Intent ë§¤ì¹­
   intent.name = "weather.query"
   â†’ supportedIntents.contains("weather.*")

2. ìš°ì„ ìˆœìœ„ ì •ë ¬
   plugins.sort(by priority DESC)

3. ì‹¤í–‰ ê°€ëŠ¥ì„± í™•ì¸
   plugin.canHandle(intent, context)
   - ê¶Œí•œ í™•ì¸
   - í•„ìˆ˜ íŒŒë¼ë¯¸í„° í™•ì¸
   - ë¦¬ì†ŒìŠ¤ ê°€ìš©ì„± í™•ì¸
```

### C. Context Engine ë°ì´í„° êµ¬ì¡°

```java
// Redis ì €ì¥ êµ¬ì¡°
Key: "context:user123:session789"
Value: {
    "userId": "user123",
    "sessionId": "session789",
    "conversationHistory": [
        {
            "timestamp": "2024-01-20T10:30:00",
            "userInput": "ì•ˆë…•",
            "systemResponse": "ì•ˆë…•í•˜ì„¸ìš”!",
            "intent": "greeting.hello",
            "confidence": 0.98
        },
        {
            "timestamp": "2024-01-20T10:30:15",
            "userInput": "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?",
            "systemResponse": "ì˜¤ëŠ˜ ì„œìš¸ì€ ë§‘ê³  23ë„ì…ë‹ˆë‹¤",
            "intent": "weather.query",
            "confidence": 0.95
        }
    ],
    "shortTermMemory": {
        "lastLocation": "ì„œìš¸",
        "lastWeatherQuery": "2024-01-20T10:30:15",
        "currentTopic": "weather"
    },
    "userState": {
        "mood": "neutral",
        "activityLevel": "active",
        "lastMotionDetected": "2024-01-20T10:29:00"
    }
}

// MongoDB ì˜êµ¬ ì €ì¥ êµ¬ì¡°
Collection: contexts
Document: {
    "_id": "context:user123:session789",
    "userId": "user123",
    "sessionId": "session789",
    "createdAt": ISODate("2024-01-20T10:00:00"),
    "lastUpdatedAt": ISODate("2024-01-20T10:30:15"),
    "conversationHistory": [...],
    "aggregatedStats": {
        "totalTurns": 15,
        "mostFrequentIntent": "weather.query",
        "averageConfidence": 0.92
    }
}
```

### D. MQTT ë©”ì‹œì§€ êµ¬ì¡°

```python
# Device â†’ Server
Topic: "device/speaker-001/audio"
Payload: {
    "requestId": "req-12345",
    "timestamp": 1234567890,
    "audio": {
        "data": "base64_encoded_audio_data...",
        "format": "PCM",
        "sampleRate": 16000,
        "channels": 1
    },
    "metadata": {
        "noiseLevel": 45.2,
        "deviceState": {
            "battery": 85,
            "wifi_strength": -45
        }
    }
}

# Server â†’ Device  
Topic: "device/speaker-001/response"
Payload: {
    "requestId": "req-12345",
    "timestamp": 1234567891,
    "audio": {
        "data": "base64_encoded_mp3...",
        "format": "MP3"
    },
    "text": "ì˜¤ëŠ˜ ì„œìš¸ì€ ë§‘ê³  23ë„ì…ë‹ˆë‹¤",
    "actions": [
        {
            "type": "led_control",
            "color": "blue",
            "pattern": "pulse"
        }
    ]
}
```

### E. ì—ëŸ¬ ì²˜ë¦¬ íë¦„

```java
// ê³„ì¸µë³„ ì—ëŸ¬ ì²˜ë¦¬
try {
    // Controller Layer
    validateRequest(request);
} catch (ValidationException e) {
    return ResponseEntity.badRequest()
        .body(ErrorResponse.of("INVALID_INPUT", e.getMessage()));
}

try {
    // Service Layer
    DialogResponse response = dialogManager.process(request);
    return ResponseEntity.ok(response);
} catch (UserNotFoundException e) {
    return ResponseEntity.status(404)
        .body(ErrorResponse.of("USER_NOT_FOUND", e.getMessage()));
} catch (RateLimitExceededException e) {
    return ResponseEntity.status(429)
        .body(ErrorResponse.of("RATE_LIMIT_EXCEEDED", "Try again later"));
} catch (Exception e) {
    // ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬
    errorReporter.report(e, request);
    return ResponseEntity.status(500)
        .body(ErrorResponse.of("INTERNAL_ERROR", "Something went wrong"));
}
```

## ğŸ” ì‹¤ë¬´ ì‹œë‚˜ë¦¬ì˜¤ë³„ ë°ì´í„° íë¦„

### ì‹œë‚˜ë¦¬ì˜¤ 1: ìºì‹œ íˆíŠ¸ ì¼€ì´ìŠ¤
```
1. Request: "ë‚ ì”¨ ì•Œë ¤ì¤˜"
2. Cache Check: Redis GET "weather:seoul:2024-01-20" â†’ HIT
3. Return cached data (latency: ~5ms)
4. Skip API call
5. Total processing time: <50ms
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì˜¤í”„ë¼ì¸ ëª¨ë“œ
```
1. Network check: Failed
2. Fallback to local NLU
3. Simple intent matching
4. Execute offline-capable plugins only
5. Use last known data from local storage
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë™ì‹œ ìš”ì²­ ì²˜ë¦¬
```
User A: "ë‚ ì”¨?" â†’ Thread 1 â†’ Plugin execution
User B: "ì‹œê°„?" â†’ Thread 2 â†’ Plugin execution  
User C: "ë‚ ì”¨?" â†’ Thread 3 â†’ Wait for User A's result (cache)
```

## ğŸ“Š ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘

```java
// Micrometer ë©”íŠ¸ë¦­
@Timed(value = "dialog.processing.time")
public DialogResponse processDialog(DialogRequest request) {
    Counter.builder("dialog.requests")
        .tag("intent", intent.getName())
        .register(meterRegistry)
        .increment();
        
    return Gauge.builder("dialog.active.sessions", 
        () -> activeSessionCount)
        .register(meterRegistry);
}

// ìˆ˜ì§‘ë˜ëŠ” ë©”íŠ¸ë¦­
- dialog.processing.time (histogram)
- dialog.requests.total (counter)
- plugin.execution.time (timer)
- cache.hit.ratio (gauge)
- error.rate (counter)
```

## ğŸ¯ í•µì‹¬ êµ¬í˜„ í¬ì¸íŠ¸

1. **ë°ì´í„° ë¶ˆë³€ì„±**
   - Request/Response ê°ì²´ëŠ” ë¶ˆë³€ìœ¼ë¡œ ì„¤ê³„
   - Builder íŒ¨í„´ ì‚¬ìš©

2. **ë¹„ë™ê¸° ì²˜ë¦¬**
   - ë¬´ê±°ìš´ ì‘ì—…ì€ CompletableFuture ì‚¬ìš©
   - ì´ë²¤íŠ¸ ë°œí–‰ì€ í•­ìƒ ë¹„ë™ê¸°

3. **ìºì‹± ì „ëµ**
   - ì½ê¸° ë§ì€ ë°ì´í„°ëŠ” ì ê·¹ì  ìºì‹±
   - TTL ì„¤ì •ìœ¼ë¡œ ì¼ê´€ì„± ë³´ì¥

4. **ì—ëŸ¬ ê²©ë¦¬**
   - í”ŒëŸ¬ê·¸ì¸ ì—ëŸ¬ê°€ ì „ì²´ ì‹œìŠ¤í…œì— ì˜í–¥ ì—†ë„ë¡
   - Circuit Breaker íŒ¨í„´ ì ìš©

5. **ëª¨ë‹ˆí„°ë§**
   - ëª¨ë“  ì£¼ìš” ì‘ì—…ì— ë©”íŠ¸ë¦­ ìˆ˜ì§‘
   - ë¶„ì‚° ì¶”ì ì„ ìœ„í•œ Request ID ì „íŒŒ